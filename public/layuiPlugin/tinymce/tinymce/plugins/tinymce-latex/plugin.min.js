!function(d){"use strict";var t=function(t,e,n,i,r,a,o){this.name=t,this.title=e,this.textarea=n,this.latexId=i,this.prefix=r,this.suffix=a,this.prefixLength=this.prefix.length,this.suffixLength=this.prefix.length,this.clazz=o,this.selector="."+this.clazz},h=(e.getMathJax=function(){return this.ready?this.mathJax:d.window.MathJax?(this.mathJax=d.window.MathJax,this.ready=!0,this.mathJax):void 0},e);function e(){}function n(c){c.ui.registry.addButton("tinymce-latex",{text:x.name,onSetup:function(){x.renderId=c.dom.uniqueId()},onAction:function(){n(null)}}),c.on("click",function(t){var e=t.target.closest(x.selector);e&&n(e)});var n=function(i){var n,t="";i&&(t=i.getAttribute(x.latexId)),e(t,function(t){var e=u(t);r(n.contentDocument,e)},function(t){var e=u(t);if(i)o(i,e),a();else{var n=d.document.createElement("span");o(n,e),c.insertContent(n.outerHTML)}t.close()}),n=d.document.getElementById(x.renderId),r(n.contentDocument,t)},o=function(t,e){t.innerHTML=e,t.setAttribute(x.latexId,e),t.setAttribute("contenteditable","false"),t.classList.add(x.clazz),t.style.cursor="pointer",t.style.display="inline-block",t.style.marginLeft="5px",t.style.marginRight="5px"},e=function(t,e,n){var i={};i[x.textarea]=t,c.windowManager.open({title:x.title,body:{type:"panel",items:[{type:"textarea",name:"latex"},{type:"htmlpanel",name:"render",html:'<iframe id="'+x.renderId+'" style="width: 100%;"></iframe>'}]},buttons:[{type:"submit",text:"保存"}],size:"large",onChange:e,onSubmit:n,initialData:i})},r=function(t,e){l(t.body,e)},a=function(){for(var t=0,e=c.getDoc().querySelectorAll(x.selector);t<e.length;t++){var n=e[t];i(n)}},i=function(t){l(t,t.getAttribute(x.latexId))},l=function(t,e){var n=h.getMathJax(),i=n.getMetricsFor(t,!0),r=n.tex2svg(e,i),a=r.querySelector("svg"),o=r.querySelector("merror");o&&((a=d.document.createElement("strong")).style.color="#dc3545",a.innerHTML="当前公式格式有误: "+o.innerHTML),t.innerHTML="",t.appendChild(a)};c.on("GetContent",function(t){var e=c.getDoc(),n=d.document.createElement("div");n.innerHTML=e.body.innerHTML;for(var i,r,a=0,o=n.querySelectorAll(x.selector);a<o.length;a++){var l=o[a];r=(i=l).getAttribute(x.latexId),i.removeAttribute("style"),i.removeAttribute("contenteditable"),i.removeAttribute("data-mce-style"),i.removeAttribute(x.latexId),i.innerHTML=s(r)}t.content=n.innerHTML}),c.on("BeforeSetContent",function(t){var e=d.document.createElement("div");e.innerHTML=t.content;for(var n=0,i=e.querySelectorAll(x.selector);n<i.length;n++){var r=i[n],a=r.getAttribute(x.latexId);a=a||f(r.innerHTML),o(r,a)}t.content=e.innerHTML}),c.on("SetContent",function(t){a()});var u=function(t){return t.getData()[x.textarea].trim()},s=function(t){return""+x.prefix+t+x.suffix},f=function(t){if(t.length>=x.prefixLength+x.suffixLength)return t.substr(x.prefixLength,t.length-(x.prefixLength+x.suffixLength))}}var x=new t("LaTex","Latex 公式录入","latex","data-latex","\\(","\\)","math-tex");tinymce.PluginManager.add("tinymce-latex",n)}(window);